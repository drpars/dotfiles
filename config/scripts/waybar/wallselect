#!/bin/bash

#-----------------------------------------------------------
# GLOBAL AYARLAR
#-----------------------------------------------------------

# Duvar Kağıtlarının Ana Dizini
DIR=$(xdg-user-dir PICTURES)/Wallpaper

# Hyprlock'un okuyacağı sabit Sembolik Bağın yolu
SYMLINK_PATH="$HOME/.config/hypr/images/wallpaper_symlink"

# hyprpaper için sabit monitör adı
MONITOR_NAME="DP-1" 

# swww için Geçiş Ayarları
bezier=.43,1.19,1,.99
fps=165
type="wave" 
duration=3
swww_opt="--transition-bezier $bezier --transition-fps $fps --transition-type $type --transition-duration $duration"

# Seçilen duvar kağıdı yolunu tutacak global değişken
SELECTED_WALLPAPER_PATH=""

#-----------------------------------------------------------
# FONKSİYONLAR
#-----------------------------------------------------------

# bstyle: İkonlu rofi seçimi (swww kullanır)
bstyle() {
  selected=$(find "$DIR" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" \) -exec basename {} \; | sort -g | while read -r rfile; do
    echo -en "$rfile\x00icon\x1f$DIR/${rfile}\n"
  done | rofi -dmenu -replace -theme ~/.config/rofi/wallpaper.rasi -disable-history)

  if [[ -n "$selected" ]]; then
    FULL_PATH="$DIR/$selected"
    swww img "$FULL_PATH" $swww_opt
    SELECTED_WALLPAPER_PATH="$FULL_PATH"
  fi
}

# cstyle: İkonlu rofi seçimi (hyprpaper kullanır)
cstyle() {
  selected_file=$(find "$DIR" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" \) -exec basename {} \; | sort -g | while read -r rfile; do
    echo -en "$rfile\x00icon\x1f$DIR/${rfile}\n"
  done | rofi -dmenu -replace -theme ~/.config/rofi/wallpaper.rasi -disable-history)

  if [[ -n "$selected_file" ]]; then
    FULL_PATH="$DIR/$selected_file"
    
    hyprctl hyprpaper preload "$FULL_PATH"
    hyprctl hyprpaper wallpaper "$MONITOR_NAME,$FULL_PATH"
    hyprctl hyprpaper unload all
    
    SELECTED_WALLPAPER_PATH="$FULL_PATH"
  fi
}

#-----------------------------------------------------------
# KOŞULLU ÇALIŞTIRMA MANTIĞI
#-----------------------------------------------------------

if pidof swww-daemon > /dev/null; then
  bstyle
    
elif pidof hyprpaper > /dev/null; then
  cstyle
    
else
  notify-send -u critical "Duvar Kağıdı Hatası" "Aktif duvar kağıdı yöneticisi bulunamadı! (swww-daemon veya hyprpaper)"
fi

#-----------------------------------------------------------
# HYPRLOCK SENKRONİZASYON BLOĞU (SYMLINK YÖNETİMİ)
#-----------------------------------------------------------

# Eğer duvar kağıdı seçimi yapıldıysa, sembolik bağı güncelle.
if [[ -n "$SELECTED_WALLPAPER_PATH" ]]; then
  # Yeni duvar kağıdına işaret eden symlink oluştur
  ln -sf "$SELECTED_WALLPAPER_PATH" "$SYMLINK_PATH"
fi
